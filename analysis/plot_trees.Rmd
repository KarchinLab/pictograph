---
title: "Simulated data -- Tree MH plots"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(coda)
library(ggmcmc)
library(gridExtra)
library(stringr)
library(fs)
library(devtools)
library(tidyverse)
library(ggnet)
library(network)
library(sna)
devtools::load_all(file.path("..", "code", "clone.tools"))

outdir <- file.path("..", "output", "plot_trees.Rmd")
```

```{r read_chains}
I <- 100; K <- 10; S <- 3
set.seed(123)
test.data <- simulateData(I, K, S)
results <- readRDS(file.path("..", "output", "mh_trees_2.Rmd", "trees.rds"))
```

# thin chains

```{r}
numIter <- length(results$score.chain)

thin <- 10

thin_chain <- function(thin, x) {
  if (thin > 1) {
    # keep only thinned rows
    x_thinned <- x[(seq_len(length(x)) %% thin) == 1]
  } else {
    x_thinned <- x
  }
  x_thinned
}

score.chain.thinned <- thin_chain(thin, results$score.chain)

thinned.tb <- tibble(score = score.chain.thinned, 
                     iter = seq_len(length(score.chain.thinned)),
                     log.score = log(score.chain.thinned))

ggplot(thinned.tb, aes(x = iter, y = log.score)) +
  geom_line() +
  theme_light()

full.tb <- tibble(score = results$score.chain, 
                  iter = seq_len(length(results$score.chain)),
                  log.score = log(results$score.chain))
ggplot(full.tb, aes(x = iter, y = log.score)) +
  geom_line() +
  theme_light()


admat.chain.thinned <- thin_chain(thin, results$admat.chain)
sampled.w.chain.thinned <- thin_chain(thin, results$sampled.w.chain)
```

# Posterior distribution of trees

```{r trees}
trees <- sapply(admat.chain.thinned, numericRepresentation)
tab <- table(trees)
length(tab)
freq <- as.numeric(tab)
prob <- freq/sum(tab)
plot(prob)
#tab2 <- tab[prob > 0.01]

max(score.chain.thinned)
max.score.ind <- which(score.chain.thinned == max(score.chain.thinned))
if(length(max.score.ind) > 1) max.score.ind <- max.score.ind[1]
max.admat <- admat.chain.thinned[[max.score.ind]]
max.admat
plotDAG(max.admat)

mostFreqTree <- names(tab[which(max(prob) == prob)])
mostFreqAdmat <- admat.chain.thinned[[which(mostFreqTree[1] == trees)[1]]]
plotDAG(mostFreqAdmat)


sc <- tibble(score = score.chain.thinned,
             index = 1:length(score.chain.thinned)) %>%
  arrange(desc(score))
top.10.score <- sc[1:10, ]

pr <- tibble(prob = prob,
             tree = names(tab)) %>%
  arrange(desc(prob))
top.10.freq <- pr[1:10, ] 



tree.plot.dir <- file.path(outdir, "trees")
dir_create(tree.plot.dir)

for (i in 1:nrow(top.10.score)) {
  adm <- admat.chain.thinned[[top.10.score$index[i]]]
  score <- top.10.score$score[i]
  dag <- plotDAG(adm)
  dag.file <- file.path(tree.plot.dir, 
                        paste0("top.score_", i, ".score_", score, ".pdf"))
  ggsave(dag.file, dag)
}



for (i in 1:10) {
  adm <- admat.chain.thinned[[match(pr[1:10, ]$tree, trees)[i]]]
  f <- top.10.freq$prob[i]
  dag <- plotDAG(adm)
  dag.file <- file.path(tree.plot.dir, 
                        paste0("top.freq_", i, ".freq_", f, ".pdf"))
  ggsave(dag.file, dag)
}

```