---
title: "Simulated data -- Tree MH plots"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(coda)
library(ggmcmc)
library(gridExtra)
library(stringr)
library(fs)
library(devtools)
library(tidyverse)
library(GGally)
library(network)
library(sna)
library(pcalg)
devtools::load_all(file.path("..", "code", "clone.tools"))

outdir <- file.path("..", "output", "plot_trees_spikenslab.Rmd")
dir_create(outdir)
```

```{r read_chains}
I <- 120; K <- 10; S <- 3
#set.seed(123)
#test.data <- simulateData(I, K, S)
results <- readRDS(file.path("..", "output", "mh_trees_spikenslab.Rmd", "trees_50k_notThinned_K10.rds"))
```

# thin chains

```{r}
numIter <- length(results$score.chain)

thin <- 10

thin.ind <- seq(1, numIter, length.out = round(numIter/thin, 1))

score.chain.thinned <- results$score.chain[thin.ind]

thinned.tb <- tibble(score = score.chain.thinned, 
                     iter = seq_len(length(score.chain.thinned)),
                     log.score = log(score.chain.thinned))

ggplot(thinned.tb, aes(x = iter, y = log.score)) +
  geom_line() +
  theme_light()

full.tb <- tibble(score = results$score.chain, 
                  iter = seq_len(length(results$score.chain)),
                  log.score = log(results$score.chain))
ggplot(full.tb, aes(x = iter, y = log.score)) +
  geom_line() +
  theme_light()


admat.chain.thinned <- results$admat.chain[thin.ind]
sampled.w.chain.thinned <- results$sampled.w.chain[thin.ind]
```

```{r true_tree}
answer <- matrix(data = 0, nrow = K+1, ncol = K,
                 dimnames = list(c("root", paste0("cluster", 1:K)),
                                 paste0("cluster", 1:K)))
answer["root", "cluster7"] <- answer["cluster7", "cluster1"] <-
    answer["cluster1", "cluster8"] <- answer["cluster1", "cluster9"] <-
    answer["cluster8", "cluster10"] <- answer["cluster8", "cluster2"] <-
    answer["cluster10", "cluster4"] <- answer["cluster2", "cluster3"] <-
    answer["cluster9", "cluster6"] <- answer["cluster6", "cluster5"] <- 1
true.graphNEL <- as(plainAdmat(answer), "graphNEL")
```

# Posterior distribution of trees

```{r trees}
trees <- sapply(admat.chain.thinned, numericRepresentation)
tab <- table(trees)
length(tab)
freq <- as.numeric(tab)
prob <- freq/sum(freq)
plot(prob)



tb <- tibble(prob = prob,
             tree = names(tab))
tb <- tb %>%
  mutate(index = match(tb$tree, trees)) 
tb <- tb %>%
  mutate(score = score.chain.thinned[tb$index])

tb <- tb %>%
  arrange(desc(score))
top.score.plots <- list()
for (i in 1:10) {
  adm <- admat.chain.thinned[[tb$index[i]]]
  g <- as(plainAdmat(adm), "graphNEL")
  dag <- plotDAG(adm) + 
    ggtitle(paste0("Rank ", i, 
                   ", freq = ", round(tb$prob[i], 4),
                   ", score = ", round(tb$score[i], 3),
                   ", shd = ", shd(true.graphNEL, g)))
  top.score.plots[[i]] <- dag
}

tb <- tb %>%
  arrange(desc(prob))
top.freq.plots <- list()
for (i in 1:10) {
  adm <- admat.chain.thinned[[tb$index[i]]]
  g <- as(plainAdmat(adm), "graphNEL")
  dag <- plotDAG(adm) + 
    ggtitle(paste0("Rank ", i, 
                   ", freq = ", round(tb$prob[i], 4),
                   ", score = ", round(tb$score[i], 3),
                   ", shd = ", shd(true.graphNEL, g)))
  top.freq.plots[[i]] <- dag
}


score.plots <- do.call(grid.arrange, c(top.score.plots, nrow=4))
ggsave(file.path(outdir, paste0("K", K, "_top.10.score.trees.pdf")), score.plots, width = 15, height = 20)

freq.plots <- do.call(grid.arrange, c(top.freq.plots, nrow=4))
ggsave(file.path(outdir, paste0("K", K, "_top.10.freq.trees.pdf")), freq.plots, width = 15, height = 20)
```